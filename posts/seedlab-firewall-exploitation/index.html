<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Seed Lab Firewall Exploitation Writeup &#183; Luke's Blog</title><meta name=title content="Seed Lab Firewall Exploitation Writeup &#183; Luke's Blog"><meta name=description content="Writeup of Seed Lab Firewall Exploitation"><meta name=keywords content="writeup,"><link rel=canonical href=https://april-aries.github.io/posts/seedlab-firewall-exploitation/><link rel=alternate type=application/rss+xml href=/posts/seedlab-firewall-exploitation/index.xml title="Luke's Blog"><link type=text/css rel=stylesheet href=/css/main.bundle.min.0a7e6a3d0f3c65992a5dcd4ffb14b7247096db4a52410a7f45155320ac6eb352b4f6922e7affc3696bee3b69b656497a248315f1c1972ae9a46af1b57b2ae330.css integrity="sha512-Cn5qPQ88ZZkqXc1P+xS3JHCW20pSQQp/RRVTIKxus1K09pIuev/DaWvuO2m2Vkl6JIMV8cGXKumkavG1eyrjMA=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.eb7ce532b76437152f4f0091659b3b6e72814900a7ec154a87366240d70fea43e3a44b5fa0353ae25dd362a44bbd98730754b42476acf9b3d233aca9d1d4261d.js integrity="sha512-63zlMrdkNxUvTwCRZZs7bnKBSQCn7BVKhzZiQNcP6kPjpEtfoDU64l3TYqRLvZhzB1S0JHas+bPSM6yp0dQmHQ==" data-copy=Copy data-copied=Copied></script><script src=/lib/zoom/zoom.min.f592a181a15d2a5b042daa7f746c3721acf9063f8b6acd175d989129865a37d400ae0e85b640f9ad42cd98d1f8ad30931718cf8811abdcc5fcb264400d1a2b0c.js integrity="sha512-9ZKhgaFdKlsELap/dGw3Iaz5Bj+Las0XXZiRKYZaN9QArg6FtkD5rULNmNH4rTCTFxjPiBGr3MX8smRADRorDA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://april-aries.github.io/posts/seedlab-firewall-exploitation/"><meta property="og:site_name" content="Luke's Blog"><meta property="og:title" content="Seed Lab Firewall Exploitation Writeup"><meta property="og:description" content="Writeup of Seed Lab Firewall Exploitation"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Seed Lab Firewall Exploitation Writeup"><meta name=twitter:description content="Writeup of Seed Lab Firewall Exploitation"><meta name=author content="Luke"><link href="https://facebook.com/profile.php?id=100027218433349" rel=me><link href=https://github.com/april-aries rel=me><link href=https://instagram.com/luke.0419 rel=me><link href=https://linkedin.com/in/bo-yu-chen-ab8a402a9/ rel=me><link href=https://twitter.com/tp61i6m6_luke rel=me><link href=https://youtube.com/@boyuchen3136 rel=me><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-G7BTC5M58S"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G7BTC5M58S")</script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 min-h-[130px] opacity-65 pl-[24px] pr-[24px] bg-gradient-to-b from-neutral from-60% dark:from-neutral-800 to-transparent mix-blend-normal z-index-80"></div><div class="fixed inset-x-0 pl-[24px] pr-[24px] z-index-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start gap-x-3 padding-main-menu"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Luke&rsquo;s Blog</a></nav><nav class="hidden md:flex items-center gap-x-5 md:ml-12 h-12"><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="About Me">About</p></a><a href=/now/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Now>Now</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title="Blog Posts">Posts</p></a><a href=/travelogue/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Travelogue>Travelogue</p></a><a href=/series/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Series>series</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title=Tags>Tags</p></a><a href=https://april-aries.github.io/posts/index.xml target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></span><p class="text-base font-medium" title>RSS</p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center gap-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400 ltr:mr-1 rtl:ml-1"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 md:hidden"><label id=menu-button class=block><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50 padding-top-[5px]"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li id=menu-close-button><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="About Me">About</p></a></li><li class=mt-1><a href=/now/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Now>Now</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title="Blog Posts">Posts</p></a></li><li class=mt-1><a href=/travelogue/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Travelogue>Travelogue</p></a></li><li class=mt-1><a href=/series/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Series>series</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title=Tags>Tags</p></a></li><li class=mt-1><a href=https://april-aries.github.io/posts/index.xml target=_blank class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 64C0 46.3 14.3 32 32 32c229.8.0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7.0 64zM128 416c0 35.3-28.7 64-64 64S0 451.3.0 416s28.7-64 64-64 64 28.7 64 64zM32 160c159.1.0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7.0-32-14.3-32-32s14.3-32 32-32z"/></svg></span></div><p class="text-bg font-bg" title>RSS</p></a></li></ul></div></label></div></div></div></div><script type=text/javascript src=/js/background-blur.min.4812321520cc2e4cd52bf9137015a55bb6c0b5e66a6b2c96b8654c0ec99be59e8e6425dd838a6fd9bac54000586f37f4a9680bbefaa2aee4601a69e188005cf6.js integrity="sha512-SBIyFSDMLkzVK/kTcBWlW7bAteZqayyWuGVMDsmb5Z6OZCXdg4pv2brFQABYbzf0qWgLvvqiruRgGmnhiABc9g==" data-target-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/background_hu_714cc33522cfa526.jpg)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><header id=single_header class="mt-5 max-w-prose"><ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden"><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/>Luke's Blog</a><span class="px-1 text-primary-500">/</span></li><li class=inline><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/>Blog Posts</a><span class="px-1 text-primary-500">/</span></li><li class=hidden><a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href=/posts/seedlab-firewall-exploitation/>Seed Lab Firewall Exploitation Writeup</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Seed Lab Firewall Exploitation Writeup</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2025-08-12T00:00:00+00:00>2025-08-12</time></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt=Luke src=/avatar_hu_3b0126cdd18e3765.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Luke</div><div class="text-sm text-neutral-700 dark:text-neutral-400">Currently a master student in NYCU High Speed Lab</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=mailto:luke041510@gmail.com target=_blank aria-label=Email rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href="https://facebook.com/profile.php?id=100027218433349" target=_blank aria-label=Facebook rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/april-aries target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://instagram.com/luke.0419 target=_blank aria-label=Instagram rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M224.1 141c-63.6.0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1.0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9.0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9.0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9.0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9.0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8.0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://linkedin.com/in/bo-yu-chen-ab8a402a9/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://twitter.com/tp61i6m6_luke target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://youtube.com/@boyuchen3136 target=_blank aria-label=Youtube rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg viewBox="0 0 576 512"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78.0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-auto overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#lab-setup>Lab Setup</a></li><li><a href=#task-1-implementing-a-simple-firewall>Task 1. Implementing a Simple Firewall</a><ul><li><a href=#task-1a-implementing-a-simple-kernel-module>Task 1A. Implementing a Simple Kernel Module</a></li><li><a href=#task-1b-implementing-a-simple-firewall-using-netfilter>Task 1B. Implementing a Simple Firewall Using Netfilter</a></li></ul></li><li><a href=#task-2-experimenting-with-stateless-firewall-rules>Task 2. Experimenting with Stateless Firewall Rules</a><ul><li><a href=#task-2a-protecting-the-router>Task 2A. Protecting the Router</a></li><li><a href=#task-2b-protecting-the-internal-network>Task 2B. Protecting the Internal Network</a></li><li><a href=#task-2c-protecting-internal-servers>Task 2C. Protecting Internal Servers</a></li></ul></li><li><a href=#task-3-connections-tracking-and-stateful-firewall>Task 3. Connections Tracking and Stateful Firewall</a><ul><li><a href=#task-3a-experimenting-with-the-connection-tracking>Task 3A. Experimenting with the Connection Tracking</a></li><li><a href=#task-3b-setting-up-a-stateful-firewall>Task 3B. Setting Up a Stateful Firewall</a></li></ul></li><li><a href=#task-4-limiting-network-traffic>Task 4. Limiting Network Traffic</a></li><li><a href=#task-5-load-balancing>Task 5. Load Balancing</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#lab-setup>Lab Setup</a></li><li><a href=#task-1-implementing-a-simple-firewall>Task 1. Implementing a Simple Firewall</a><ul><li><a href=#task-1a-implementing-a-simple-kernel-module>Task 1A. Implementing a Simple Kernel Module</a></li><li><a href=#task-1b-implementing-a-simple-firewall-using-netfilter>Task 1B. Implementing a Simple Firewall Using Netfilter</a></li></ul></li><li><a href=#task-2-experimenting-with-stateless-firewall-rules>Task 2. Experimenting with Stateless Firewall Rules</a><ul><li><a href=#task-2a-protecting-the-router>Task 2A. Protecting the Router</a></li><li><a href=#task-2b-protecting-the-internal-network>Task 2B. Protecting the Internal Network</a></li><li><a href=#task-2c-protecting-internal-servers>Task 2C. Protecting Internal Servers</a></li></ul></li><li><a href=#task-3-connections-tracking-and-stateful-firewall>Task 3. Connections Tracking and Stateful Firewall</a><ul><li><a href=#task-3a-experimenting-with-the-connection-tracking>Task 3A. Experimenting with the Connection Tracking</a></li><li><a href=#task-3b-setting-up-a-stateful-firewall>Task 3B. Setting Up a Stateful Firewall</a></li></ul></li><li><a href=#task-4-limiting-network-traffic>Task 4. Limiting Network Traffic</a></li><li><a href=#task-5-load-balancing>Task 5. Load Balancing</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h2 class="relative group">Lab Setup<div id=lab-setup class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#lab-setup aria-label=Anchor>#</a></span></h2><p>輸入下面的指令建立環境</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ dcbuild    <span class=c1># 建立環境。完整指令：docker-compose build</span>
</span></span><span class=line><span class=cl>$ dcup -d    <span class=c1># 在背景執行環境。完整指令：docker-compose up -d</span>
</span></span><span class=line><span class=cl>$ dockps     <span class=c1># 查詢正在執行的 containers。完整指令：docker ps --format &#34;{{.ID}} {{.Names}}&#34;</span>
</span></span></code></pre></div><p>這個 lab 使用六台機器</p><table><thead><tr><th>IP</th><th>說明</th></tr></thead><tbody><tr><td>10.9.0.1</td><td>攻擊者</td></tr><tr><td>10.9.0.5</td><td>Host A</td></tr><tr><td>192.168.60.11</td><td>Router</td></tr><tr><td>192.168.60.5</td><td>Host 1</td></tr><tr><td>192.168.60.6</td><td>Host 2</td></tr><tr><td>192.168.60.7</td><td>Host 3</td></tr></tbody></table><h2 class="relative group">Task 1. Implementing a Simple Firewall<div id=task-1-implementing-a-simple-firewall class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-1-implementing-a-simple-firewall aria-label=Anchor>#</a></span></h2><p>因為封包處理是透過 kernel，因此如果要設計防火牆就必須更改 Linux kernel。確實過去是透過重編 Linux kernel 做到，但現今 Linux 提供不需要重編 kernel 的新機制來操縱封包，包含 Loadable Kernel Module (LKM) 和 Netfilter</p><h3 class="relative group">Task 1A. Implementing a Simple Kernel Module<div id=task-1a-implementing-a-simple-kernel-module class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-1a-implementing-a-simple-kernel-module aria-label=Anchor>#</a></span></h3><p>Task 1A 要熟悉 LKM 的使用，使用到的檔案包含 <em>Files/kernel_module</em> 下的兩個檔案： <em>hello.c</em> 以及 <em>Makefile</em></p><p>LKM 讓使用者在程式運行時新增新的 module 到 kernel。 <em>hello.c</em> 中時做了兩個 functions <code>initialization</code> 和 <code>cleanup</code>，兩個 function 都會在 kernel log 以 informational level 輸出一段訊息（log 在 <em>/var/log/syslog</em> ，可以透過 <code>dmesg</code> 指令印出）。第 15 行設定當 module 被初始化時要執行 <code>initialization</code> 函式，第 16 行設定當 module 被移除時要執行 <code>cleanup</code> 函式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>initialization</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Hello World!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>cleanup</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Bye-bye World!.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>initialization</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>cleanup</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>Makefile 將 <em>hello.c</em> 編成 LKM，使用 <code>make</code> 指令編譯，使用 <code>make clean</code> 移除相關檔案</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>obj-m</span> <span class=o>+=</span> hello.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	make -C /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	make -C /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> clean
</span></span></code></pre></div><p>編譯完成後的 kernel module 為 <em>hello.ko</em> ，接著依序執行下列指令測試 module 是否正常運行</p><table><thead><tr><th>指令</th><th>說明</th></tr></thead><tbody><tr><td><code>sudo insmod hello.ko</code></td><td>插入 module (insert module)</td></tr><tr><td><code>lsmod | grep hello</code></td><td>列出所有 modules</td></tr><tr><td><code>sudo rmmod hello</code></td><td>移除 module (remove module)</td></tr><tr><td><code>dmesg</code></td><td>印出 log 訊息</td></tr></tbody></table><p>會在最下方看到兩則訊息 &ldquo;Hello World!&rdquo; 以及 &ldquo;Bye-bye World!&rdquo; 的訊息。&ldquo;Hello World!&rdquo; 是在插入 module 時將 module 初始化而印出，&ldquo;Bye-bye World!&rdquo; 則是在移除 module 時印出，也證實新增的 module 有正常運行</p><h3 class="relative group">Task 1B. Implementing a Simple Firewall Using Netfilter<div id=task-1b-implementing-a-simple-firewall-using-netfilter class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-1b-implementing-a-simple-firewall-using-netfilter aria-label=Anchor>#</a></span></h3><p>Task 1B 會透過 netfilter 實作一個 packet filter LKM。Netfilter 是在 Linux kernel 上實作一系列的 hook functions，當 packet 經過特定位置，就會觸發 hooks 上的函式，而使用者只要設計 hook 上的 funciton logic 即可</p><p>以提供的程式碼為例，在 <em>Files/packet_filter</em> 中一樣有兩個檔案： <em>seedFilter.c</em> 和 <em>Makefile</em></p><p>在 <em>seedFilter.c</em> 中</p><p>第 12 行建立了 nf_hook_ops 結構的兩個 hooks，nf_hook_ops 結構包含 protocol、hook 執行點、執行動作等等</p><p>第 15 行是自定義的 hook function <code>blockUDP</code>，會去檢查封包 protocol，如果是 UDP 封包且符合 IP <code>8.8.8.8</code> port 53 則 drop 掉，否則放行。換句話說，這個函式在阻擋內部傳送 DNS query 到 <code>8.8.8.8</code></p><p>第 41 行也是自訂義的 hook function <code>printInfo</code>，會去讀取封包資訊並印出，讀取資訊包含 hook 狀態、來源與目的位址以及 protocol，因為這個 hook function 並不是在做過濾，所以執行完一律放行封包</p><p>第 74 行 <code>registerFilter</code> 函式註冊了兩個 hooks，<code>hook1</code> 在 IPv4 (<code>PF_INET</code>) 封包從內部傳送出去時會觸發 (<code>NF_INET_LOCAL_OUT</code>)，觸發時會呼叫 <code>printInfo</code> 這隻函式，hook 優先級設為最先；<code>hook2</code> 在 IPv4 (<code>PF_INET</code>) 封包從內部傳送或轉發時會觸發 (<code>NF_INET_POST_ROUTING</code>)，觸發時會呼叫 <code>blockUDP</code> 這隻函式，hook 優先級同樣設為最先。要注意的是第 81 和第 87 行的 <code>nf_register_net_hook</code> 函式才是真的將 function 掛到 hook 上。第 98 行提到 <code>registerFilter</code> 函式會在 module 初始化時被呼叫。</p><p>第 92 行 <code>removeFilter</code> 函式取消註冊上述提到的兩個 hooks。第 99 行提到 <code>removeFilter</code> 函式會在 module 被移除時被呼叫。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/kernel.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/module.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/netfilter.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/netfilter_ipv4.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/ip.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/tcp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/udp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/if_ether.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>nf_hook_ops</span> <span class=n>hook1</span><span class=p>,</span> <span class=n>hook2</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>blockUDP</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>priv</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sk_buff</span> <span class=o>*</span><span class=n>skb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=k>const</span> <span class=k>struct</span> <span class=n>nf_hook_state</span> <span class=o>*</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>iphdr</span> <span class=o>*</span><span class=n>iph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>udphdr</span> <span class=o>*</span><span class=n>udph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>u16</span>  <span class=n>port</span>   <span class=o>=</span> <span class=mi>53</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>char</span> <span class=n>ip</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;8.8.8.8&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>u32</span>  <span class=n>ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>skb</span><span class=p>)</span> <span class=k>return</span> <span class=n>NF_ACCEPT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>iph</span> <span class=o>=</span> <span class=nf>ip_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Convert the IPv4 address from dotted decimal to 32-bit binary
</span></span></span><span class=line><span class=cl>   <span class=nf>in4_pton</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>ip_addr</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>IPPROTO_UDP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>udph</span> <span class=o>=</span> <span class=nf>udp_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>daddr</span> <span class=o>==</span> <span class=n>ip_addr</span> <span class=o>&amp;&amp;</span> <span class=nf>ntohs</span><span class=p>(</span><span class=n>udph</span><span class=o>-&gt;</span><span class=n>dest</span><span class=p>)</span> <span class=o>==</span> <span class=n>port</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_WARNING</span> <span class=s>&#34;*** Dropping %pI4 (UDP), port %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>daddr</span><span class=p>),</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>NF_DROP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>NF_ACCEPT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>printInfo</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>priv</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sk_buff</span> <span class=o>*</span><span class=n>skb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=k>const</span> <span class=k>struct</span> <span class=n>nf_hook_state</span> <span class=o>*</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>iphdr</span> <span class=o>*</span><span class=n>iph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>char</span> <span class=o>*</span><span class=n>hook</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>char</span> <span class=o>*</span><span class=n>protocol</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>switch</span> <span class=p>(</span><span class=n>state</span><span class=o>-&gt;</span><span class=n>hook</span><span class=p>){</span>
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>NF_INET_LOCAL_IN</span><span class=p>:</span>     <span class=n>hook</span> <span class=o>=</span> <span class=s>&#34;LOCAL_IN&#34;</span><span class=p>;</span>     <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>NF_INET_LOCAL_OUT</span><span class=p>:</span>    <span class=n>hook</span> <span class=o>=</span> <span class=s>&#34;LOCAL_OUT&#34;</span><span class=p>;</span>    <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>NF_INET_PRE_ROUTING</span><span class=p>:</span>  <span class=n>hook</span> <span class=o>=</span> <span class=s>&#34;PRE_ROUTING&#34;</span><span class=p>;</span>  <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>NF_INET_POST_ROUTING</span><span class=p>:</span> <span class=n>hook</span> <span class=o>=</span> <span class=s>&#34;POST_ROUTING&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>NF_INET_FORWARD</span><span class=p>:</span>      <span class=n>hook</span> <span class=o>=</span> <span class=s>&#34;FORWARD&#34;</span><span class=p>;</span>      <span class=k>break</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>     <span class=k>default</span><span class=o>:</span>                   <span class=n>hook</span> <span class=o>=</span> <span class=s>&#34;IMPOSSIBLE&#34;</span><span class=p>;</span>   <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;*** %s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>hook</span><span class=p>);</span> <span class=c1>// Print out the hook info
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>iph</span> <span class=o>=</span> <span class=nf>ip_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=k>switch</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>protocol</span><span class=p>){</span>
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>IPPROTO_UDP</span><span class=p>:</span>  <span class=n>protocol</span> <span class=o>=</span> <span class=s>&#34;UDP&#34;</span><span class=p>;</span>   <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>IPPROTO_TCP</span><span class=p>:</span>  <span class=n>protocol</span> <span class=o>=</span> <span class=s>&#34;TCP&#34;</span><span class=p>;</span>   <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=k>case</span> <span class=nl>IPPROTO_ICMP</span><span class=p>:</span> <span class=n>protocol</span> <span class=o>=</span> <span class=s>&#34;ICMP&#34;</span><span class=p>;</span>  <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=k>default</span><span class=o>:</span>           <span class=n>protocol</span> <span class=o>=</span> <span class=s>&#34;OTHER&#34;</span><span class=p>;</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Print out the IP addresses and protocol
</span></span></span><span class=line><span class=cl>   <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;    %pI4  --&gt; %pI4 (%s)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=o>&amp;</span><span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span><span class=p>),</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>daddr</span><span class=p>),</span> <span class=n>protocol</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>NF_ACCEPT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>registerFilter</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;Registering filters.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>hook1</span><span class=p>.</span><span class=n>hook</span> <span class=o>=</span> <span class=n>printInfo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook1</span><span class=p>.</span><span class=n>hooknum</span> <span class=o>=</span> <span class=n>NF_INET_LOCAL_OUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook1</span><span class=p>.</span><span class=n>pf</span> <span class=o>=</span> <span class=n>PF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook1</span><span class=p>.</span><span class=n>priority</span> <span class=o>=</span> <span class=n>NF_IP_PRI_FIRST</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>nf_register_net_hook</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_net</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hook1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>hook2</span><span class=p>.</span><span class=n>hook</span> <span class=o>=</span> <span class=n>blockUDP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook2</span><span class=p>.</span><span class=n>hooknum</span> <span class=o>=</span> <span class=n>NF_INET_POST_ROUTING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook2</span><span class=p>.</span><span class=n>pf</span> <span class=o>=</span> <span class=n>PF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook2</span><span class=p>.</span><span class=n>priority</span> <span class=o>=</span> <span class=n>NF_IP_PRI_FIRST</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>nf_register_net_hook</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_net</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hook2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>removeFilter</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_INFO</span> <span class=s>&#34;The filters are being removed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nf>nf_unregister_net_hook</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_net</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hook1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nf>nf_unregister_net_hook</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_net</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hook2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>module_init</span><span class=p>(</span><span class=n>registerFilter</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>module_exit</span><span class=p>(</span><span class=n>removeFilter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>MODULE_LICENSE</span><span class=p>(</span><span class=s>&#34;GPL&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>Makefile 將 <em>seedFilter.c</em> 編成 LKM，使用 <code>make</code> 指令編譯；使用 <code>make clean</code> 移除相關檔案；使用 <code>make ins</code> 插入 <code>seedFilter</code> 模組；使用 <code>make rm</code> 移除 <code>seedFilter</code> 模組</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>obj-m</span> <span class=o>+=</span> seedFilter.o
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	make -C /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	make -C /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> clean
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>ins</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	sudo dmesg -C
</span></span><span class=line><span class=cl>	sudo insmod seedFilter.ko
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>rm</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	sudo rmmod seedFilter
</span></span></code></pre></div><ol><li>Subtask 1. 嘗試傳送 DNS query 到 <code>8.8.8.8</code><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>seed@VM:~/.../packet_filter$ dig @8.8.8.8 www.example.com
</span></span><span class=line><span class=cl>^C
</span></span></code></pre></div>發現 Query 不到</li><li>Subtask 2. Hook <code>printInfo</code> 函式到其他 hook numbers，也就是 <code>NF_INET_PRE_ROUTING</code>, <code>NF_INET_LOCAL_IN</code>, <code>NF_INET_FORWARD</code>, <code>NF_INET_LOCAL_OUT</code>, <code>NF_INET_POST_ROUTING</code><table><thead><tr><th>Chain</th><th>hook number</th><th>說明</th></tr></thead><tbody><tr><td>PREROUTING</td><td>NF_IP_PRE_ROUTING</td><td>封包進入 router 前</td></tr><tr><td>INPUT</td><td>NF_IP_LOCAL_IN</td><td>通過 router 後，目的地為本機</td></tr><tr><td>FORWARD</td><td>NF_IP_FORWARD</td><td>通過 router 後，目的地不為本機</td></tr><tr><td>OUTPUT</td><td>NF_IP_LOCAL_OUT</td><td>由本機產生向外轉發</td></tr><tr><td>POSTROUTING</td><td>NF_IP_POST_ROUTING</td><td>發送到網卡接口之前</td></tr></tbody></table></li><li>Subtask 3. 開發另外兩個 hooks 來假裝其他電腦去 ping / telnet VM
設計概念是如果遇到 ping 或 telnet 封包的 destination IP 是 host VM，就把 source ip 改為其他值。這邊 host VM 的 IP address 是 10.9.0.1，我會用 10.9.0.5 這台機器去執行連線，如果收到這個 IP，就將其改為 10.9.0.6，最後一樣將相關資訊印在 log 檔
判斷 ping 封包的方式是透過 protocol 是否為 ICMP，而判斷 telnet 封包則是以 destination port 為 23
修改部分的程式碼如下，詳細資訊請見註解<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 開頭需要新增兩行 include library，因為 pretend() 會用到 TCP 和 ICMP header 的定義
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/tcp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;linux/icmp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 原程式碼需新增 hook3 為 pretend 所用
</span></span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>nf_hook_ops</span> <span class=n>hook1</span><span class=p>,</span> <span class=n>hook2</span><span class=p>,</span> <span class=n>hook3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 新增 pretend function 實作 task 要求
</span></span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>int</span> <span class=nf>pretend</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>priv</span><span class=p>,</span> <span class=k>struct</span> <span class=n>sk_buff</span> <span class=o>*</span><span class=n>skb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=k>const</span> <span class=k>struct</span> <span class=n>nf_hook_state</span> <span class=o>*</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>iphdr</span> <span class=o>*</span><span class=n>iph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>udphdr</span> <span class=o>*</span><span class=n>udph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>tcphdr</span> <span class=o>*</span><span class=n>tcph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>icmphdr</span> <span class=o>*</span><span class=n>icmph</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>u16</span>  <span class=n>port</span>   <span class=o>=</span> <span class=mi>23</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>char</span> <span class=n>target_ip</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;10.9.0.1&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>u32</span>  <span class=n>target_ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>char</span> <span class=n>src_ip</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;192.168.60.5&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>u32</span>  <span class=n>src_ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>char</span> <span class=n>fake_ip</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=s>&#34;192.168.60.7&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>u32</span>  <span class=n>fake_ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>skb</span><span class=p>)</span> <span class=k>return</span> <span class=n>NF_ACCEPT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>iph</span> <span class=o>=</span> <span class=nf>ip_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nf>in4_pton</span><span class=p>(</span><span class=n>target_ip</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>target_ip_addr</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nf>in4_pton</span><span class=p>(</span><span class=n>src_ip</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>src_ip_addr</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=nf>in4_pton</span><span class=p>(</span><span class=n>fake_ip</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>fake_ip_addr</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Pretending ping
</span></span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>IPPROTO_ICMP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>icmph</span> <span class=o>=</span> <span class=nf>icmp_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span> <span class=o>==</span> <span class=n>src_ip_addr</span> <span class=o>&amp;&amp;</span> <span class=n>iph</span><span class=o>-&gt;</span><span class=n>daddr</span> <span class=o>==</span> <span class=n>target_ip_addr</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span> <span class=o>=</span> <span class=n>fake_ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_WARNING</span> <span class=s>&#34;*** Pretending as %pI4 (ICMP) as ping</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Pretending telnet
</span></span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>IPPROTO_TCP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>tcph</span> <span class=o>=</span> <span class=nf>tcp_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span> <span class=o>==</span> <span class=n>src_ip_addr</span> <span class=o>&amp;&amp;</span> <span class=n>iph</span><span class=o>-&gt;</span><span class=n>daddr</span> <span class=o>==</span> <span class=n>target_ip_addr</span> <span class=o>&amp;&amp;</span> <span class=nf>ntohs</span><span class=p>(</span><span class=n>tcph</span><span class=o>-&gt;</span><span class=n>dest</span><span class=p>)</span> <span class=o>==</span> <span class=n>port</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span> <span class=o>=</span> <span class=n>fake_ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_WARNING</span> <span class=s>&#34;*** Pretending as %pI4 (ICMP) as telnet</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>IPPROTO_UDP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>udph</span> <span class=o>=</span> <span class=nf>udp_hdr</span><span class=p>(</span><span class=n>skb</span><span class=p>);</span>           
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span> <span class=o>==</span> <span class=n>src_ip_addr</span> <span class=o>&amp;&amp;</span> <span class=n>iph</span><span class=o>-&gt;</span><span class=n>daddr</span> <span class=o>==</span> <span class=n>target_ip_addr</span> <span class=o>&amp;&amp;</span> <span class=nf>ntohs</span><span class=p>(</span><span class=n>udph</span><span class=o>-&gt;</span><span class=n>dest</span><span class=p>)</span> <span class=o>==</span> <span class=n>port</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span> <span class=o>=</span> <span class=n>fake_ip_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>printk</span><span class=p>(</span><span class=n>KERN_WARNING</span> <span class=s>&#34;*** Pretending as %pI4 (ICMP) as telnet</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>iph</span><span class=o>-&gt;</span><span class=n>saddr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>NF_ACCEPT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// registerFilter 函式新增 hook3 的操作，並將 hook 掛到 POSTROUTING 上
</span></span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>registerFilter</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=p>...</span>
</span></span><span class=line><span class=cl>   <span class=n>hook3</span><span class=p>.</span><span class=n>hook</span> <span class=o>=</span> <span class=n>pretend</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook3</span><span class=p>.</span><span class=n>hooknum</span> <span class=o>=</span> <span class=n>NF_INET_POST_ROUTING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook3</span><span class=p>.</span><span class=n>pf</span> <span class=o>=</span> <span class=n>PF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>hook3</span><span class=p>.</span><span class=n>priority</span> <span class=o>=</span> <span class=n>NF_IP_PRI_FIRST</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>nf_register_net_hook</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_net</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hook3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// removeFilter 也需要新增 hook3 的移除
</span></span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>removeFilter</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=p>...</span>
</span></span><span class=line><span class=cl>   <span class=nf>nf_unregister_net_hook</span><span class=p>(</span><span class=o>&amp;</span><span class=n>init_net</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>hook3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>    
</span></span></code></pre></div>結果如下，為了方便觀察，我將 hook1 的 printInfo 掛到 POSTROUTING 上，可以看到雖然我是進 192.168.60.5 機器進行 ping 和 telnet 主機，但 source 都轉成 192.168.60.7
<img src=Task1B-1.png alt=Task1B-1 width=100%>
下面這張執行結果顯示一個小問題：如果要讓 192.168.60.5 收到回傳訊息，就要多在 router 設定當收到給予 192.168.60.7 的 ping 或 telnet 回傳封包，需要將 destination IP 轉回 192.168.60.5，否則 192.168.60.5 會收不到回應封包，不過這邊我沒實作，所以 192.168.60.5 收不到回傳結果
<img src=Task1B-2.png alt=Task1B-2 width=100%></li></ol><div class="flex px-4 py-3 rounded-md" style=background-color:#e63946><span class="ltr:pr-3 rtl:pl-3 flex items-center" style=color:#1d3557><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg>
</span></span><span style=color:#f1faee>每次重編記得要 <code>make rm</code> 把 module 清除，重編後再透過 <code>make ins</code> 把 module 插進去</span></div><h2 class="relative group">Task 2. Experimenting with Stateless Firewall Rules<div id=task-2-experimenting-with-stateless-firewall-rules class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-2-experimenting-with-stateless-firewall-rules aria-label=Anchor>#</a></span></h2><p>Linux 有基於 netfilter 內建好的防火牆叫做 <code>iptables</code>，原則上 <code>iptables</code> 是 user-space 而 <code>Xtables</code> 是 kernel space，但實際上 <code>iptables</code> 常被拿來做兩者的開發</p><p><code>iptables</code> 並不是只拿來過濾封包，它可以用來做階層式的規則，包含 <strong>表 (table)、鏈 (chain)、規則 (rules)</strong>。</p><ul><li>每張「表」指的是不同類型的封包處理流程，系統按照預訂的規則將封包通過某個內建「鏈」</li><li>「鏈」中可以存在多條「規則」，這些規則會被逐一進行過濾，一旦滿足規則可以執行相應的動作</li><li>當鏈中所有規則都執行完仍然沒有跳轉時，將根據該鏈的預設策略 (policy) 執行對應動作</li></ul><ul><li>如果也沒有預設動作，則是返回呼叫者鏈</li></ul><p>詳細資訊如下表所示</p><table><thead><tr><th style=text-align:left>Table</th><th style=text-align:left>Chains</th><th style=text-align:left>Functionalities</th></tr></thead><tbody><tr><td style=text-align:left>Filter</td><td style=text-align:left>INPUT<br>FORWARD<br>OUTPUT</td><td style=text-align:left>預設 table，通常用於封包過濾</td></tr><tr><td style=text-align:left>NAT</td><td style=text-align:left>PREROUTING<br>INPUT<br>OUTPUT<br>POSTROUTING</td><td style=text-align:left>來源 / 目標 IP 位址轉換</td></tr><tr><td style=text-align:left>Mangle</td><td style=text-align:left>PREROUTING<br>INPUT<br>FORWARD<br>OUTPUT<br>POSTROUTING</td><td style=text-align:left>更改封包內容</td></tr><tr><td style=text-align:left>Raw</td><td style=text-align:left>PREROUTING<br>OUTPUT</td><td style=text-align:left>處理異常</td></tr></tbody></table><p>每張 table 有多條 chain，每條 chain 都對應到 netfilter 中的不同 hook，如下表所示</p><table><thead><tr><th style=text-align:left>Chain</th><th style=text-align:left>Netfilter Hook</th><th style=text-align:left>Note</th></tr></thead><tbody><tr><td style=text-align:left>PREROUTING</td><td style=text-align:left>NF_INET_PREROUTING</td><td style=text-align:left>處理路由規則前通過，通常用於目的位址轉換 (DNAT)</td></tr><tr><td style=text-align:left>INPUT</td><td style=text-align:left>NF_INET_LOCAL_IN</td><td style=text-align:left>發送往本機的封包</td></tr><tr><td style=text-align:left>FORWARD</td><td style=text-align:left>NF_INET_FORWARD</td><td style=text-align:left>本機轉發的封包</td></tr><tr><td style=text-align:left>OUTPUT</td><td style=text-align:left>NF_INET_LOCAL_OUT</td><td style=text-align:left>從本機發送出的封包</td></tr><tr><td style=text-align:left>POSTROUTING</td><td style=text-align:left>NF_INET_POSTROUTING</td><td style=text-align:left>完成路由規則後通過，通常用於來源位址轉換 (SNAT)</td></tr></tbody></table><p>每條 chain 上都能制定不同規則，比如要阻擋外部主機 ping 內部主機，可以在 filter table 中的 INPUT chain 上制定一條規則，阻止所有 ping 封包</p><p>要在 chain 上新增規則會使用到 <code>iptables</code> 指令，基本架構如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t &lt;table&gt; -&lt;operation&gt; &lt;chain&gt; &lt;rule&gt; -j &lt;target&gt;
</span></span></code></pre></div><p>各項參數詳細資訊如下表</p><table><thead><tr><th style=text-align:left>Operation</th><th style=text-align:left>說明</th></tr></thead><tbody><tr><td style=text-align:left><code>-A</code>, <code>--append</code> chain rule-specification</td><td style=text-align:left>附加一條規則至某條 chain 上</td></tr><tr><td style=text-align:left><code>-C</code>, <code>--check</code> chain rule-specification</td><td style=text-align:left>檢查某規則是否存在於某 chain 中</td></tr><tr><td style=text-align:left><code>-D</code>, <code>--delete</code> chain rule-specification<br><code>-D</code>, <code>--delete</code> chain rulenum</td><td style=text-align:left>刪除 chain 上的特定規則</td></tr><tr><td style=text-align:left><code>-I</code>, <code>--insert</code> chain (rulenum) rule-specification</td><td style=text-align:left>新增規則至特定 chain</td></tr><tr><td style=text-align:left><code>-R</code>, <code>--replace</code> chain rulenum rule-specification</td><td style=text-align:left>更新 chain 上的某條規則</td></tr><tr><td style=text-align:left><code>-L</code>, <code>--list</code> (chain)</td><td style=text-align:left>顯示指定 chain 的所有規則</td></tr><tr><td style=text-align:left><code>-S</code>, <code>--list-rules</code> (chain)</td><td style=text-align:left>顯示指定 chain 的所有規則</td></tr><tr><td style=text-align:left><code>-F</code>, <code>--flush</code> (chain)</td><td style=text-align:left>刪除指定 chain 的所有規則</td></tr><tr><td style=text-align:left><code>-N</code>, <code>--new-chain</code> chain</td><td style=text-align:left>創建新的 chain</td></tr><tr><td style=text-align:left><code>-X</code>, <code>--delete-chain</code> (chain)</td><td style=text-align:left>刪除指定 chain<br>內建 chain 僅能透過 <code>iptables-nft</code> 刪除</td></tr><tr><td style=text-align:left><code>-P</code>, <code>--policy</code> chain target</td><td style=text-align:left>指定內建 chain 的 policy target<br>target 只能是 ACCEPT 或 DROP，且僅適用於內建 chains</td></tr><tr><td style=text-align:left><code>-E</code>, <code>--rename-chain</code> old-chain new-chain</td><td style=text-align:left>重新命名 chain</td></tr><tr><td style=text-align:left><code>-V</code>, <code>--version</code></td><td style=text-align:left>顯示 <code>iptables</code> 版本</td></tr><tr><td style=text-align:left><code>-h</code></td><td style=text-align:left>顯示 help message</td></tr><tr><td style=text-align:left><code>-p</code>, <code>--protocol</code> protocol</td><td style=text-align:left>指定 protocol<br>包含 tcp, udp, udplite, icmp, icmpv6, esp, ah, sctp, mh 或 &ldquo;all&rdquo; 或其他於 <code>/etc/protocols</code> 紀載的協定<br>可使用數值指定<br><code>!</code> 可用來反轉過濾邏輯</td></tr><tr><td style=text-align:left><code>-s</code>, <code>--src</code>, <code>--source</code> address</td><td style=text-align:left>指定來源，如 <code>-sport</code><br><code>!</code> 可用來反轉過濾邏輯</td></tr><tr><td style=text-align:left><code>-d</code>, <code>--dst</code>, <code>--destination</code> address</td><td style=text-align:left>指定目的地，如 <code>--dport</code><br><code>!</code> 可用來反轉過濾邏輯</td></tr><tr><td style=text-align:left><code>-m</code>, <code>--match</code> match</td><td style=text-align:left></td></tr><tr><td style=text-align:left><code>-j</code>, <code>--jump</code> target</td><td style=text-align:left>指定當滿足特定 rules 時須執行的 target action<br>target 包含 ACCEPT、REJECT、DROP、LOG、SNAT、MASQUERADE、DNAT、REDIRECT、RETURN</td></tr><tr><td style=text-align:left><code>-g</code>, <code>--goto</code> chain</td><td style=text-align:left>跳至指定 chain</td></tr><tr><td style=text-align:left><code>-v</code>, <code>--verbose</code></td><td style=text-align:left>顯示更多資訊</td></tr></tbody></table><table><thead><tr><th style=text-align:left>Target</th><th style=text-align:left>說明</th></tr></thead><tbody><tr><td style=text-align:left>ACCEPT</td><td style=text-align:left>放行，結束後跳至下一規則鏈</td></tr><tr><td style=text-align:left>REJECT</td><td style=text-align:left>攔截，並通知傳送方<br>通知選項包含 ICMP port-unreachable、ICMP echo-reply 或是tcp-reset<br>結束後中斷過濾程序</td></tr><tr><td style=text-align:left>DROP</td><td style=text-align:left>丟棄，結束後中斷過濾程序</td></tr><tr><td style=text-align:left>REDIRECT</td><td style=text-align:left>導向另一個 port (PNAT)<br>結束後繼續進行其他規則檢查</td></tr><tr><td style=text-align:left>MASQUERADE</td><td style=text-align:left>改寫封包來源 IP 為防火牆 NIC IP，可指定 port 對應範圍<br>結束後跳往下一規則</td></tr><tr><td style=text-align:left>SNAT</td><td style=text-align:left>改寫封包來源 IP 為某特定 IP 或 IP 範圍<br>可指定 port 對應範圍<br>結束後跳往下一規則</td></tr><tr><td style=text-align:left>DNAT</td><td style=text-align:left>改寫封包來源 IP 為某特定 IP 或 IP 範圍，可指定 port 對應範圍<br>結束後跳往下一規則鏈</td></tr><tr><td style=text-align:left>MIRROR</td><td style=text-align:left>鏡射，將來源 IP 與目的地 IP 做對調並送回<br>結束後中斷過濾程序</td></tr><tr><td style=text-align:left>QUEUE</td><td style=text-align:left>中斷過濾程序，放入 queue 中並返回主規則鏈<br>白話文：提前結束返回主規則鏈</td></tr><tr><td style=text-align:left>RETURN</td><td style=text-align:left>結束在目前規則鏈中的過濾程序，返回主規則鏈</td></tr><tr><td style=text-align:left>LOG</td><td style=text-align:left>將封包相關訊息紀錄於 <code>/var/log</code><br>可於 <code>/etc/syslog.conf</code> 中設定<br>結束後繼續進行其他規則檢查</td></tr><tr><td style=text-align:left>MARK</td><td style=text-align:left>將封包標上做標記，供後續使用<br>結束後繼續進行其他規則檢查</td></tr></tbody></table><h3 class="relative group">Task 2A. Protecting the Router<div id=task-2a-protecting-the-router class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-2a-protecting-the-router aria-label=Anchor>#</a></span></h3><p>Task 2A 要防止其他外部主機透過 ping 以外的方式存取到 router，指令如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 新增一條規則：進來的封包如果是 ping 就放行</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 新增一條規則：出去的封包如果是 ping 就放行</span>
</span></span><span class=line><span class=cl>iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 設定 OUTPUT chain 上的 policy：預設丟棄所有封包</span>
</span></span><span class=line><span class=cl>iptables -P OUTPUT DROP
</span></span><span class=line><span class=cl><span class=c1># 設定 INPUT chain 上的 policy：預設丟棄所有封包</span>
</span></span><span class=line><span class=cl>iptables -P INPUT DROP
</span></span></code></pre></div><p>實驗結果發現可以從外部 ping 到 router，但無法 telnet 進去。可以 ping 的原因是防火牆第一二條規則設定允許 ping 封包進入，並允許 ping 封包回應，所以外部主機收的到結果；但 telnet 不屬於 ping 封包，所以會在第三四條規則被阻擋
<img src=Task2A-1.png alt=Task2A-1 width=100%></p><div class="flex px-4 py-3 rounded-md" style=background-color:#e63946><span class="ltr:pr-3 rtl:pl-3 flex items-center" style=color:#1d3557><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg>
</span></span><span style=color:#f1faee><p>Task 實作完要輸入以下指令清除新增的規則</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 清除所有在 filter table 上的規則</span>
</span></span><span class=line><span class=cl>iptables -F
</span></span><span class=line><span class=cl><span class=c1># 設定 OUTPUT chain 上的 policy：預設放行</span>
</span></span><span class=line><span class=cl>iptables -P OUTPUT ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 設定 INPUT chain 上的 policy：預設放行</span>
</span></span><span class=line><span class=cl>iptables -P INPUT ACCEPT
</span></span></code></pre></div><p>或直接透過重啟 docker (<code>docker restart &lt;docker ID></code>) 清除規則</p></span></div><h3 class="relative group">Task 2B. Protecting the Internal Network<div id=task-2b-protecting-the-internal-network class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-2b-protecting-the-internal-network aria-label=Anchor>#</a></span></h3><p>Task 2B 要在 router 上設定規則保護內網 (192.168.60.0/24)，因為是從 router 轉出去，所以會用到 FORWARD table。Task 2B 要做到的事情如下</p><ol><li>外部主機無法 ping 內部主機</li><li>外部主機可以 ping router</li><li>內部主機可以 ping 外部主機</li><li>其他來往外部、內部的封包都應該被阻擋</li></ol><p>指令如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 外部主機無法 ping 內部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p icmp --icmp-type echo-request -d 192.168.60.0/24 -j DROP
</span></span><span class=line><span class=cl><span class=c1># 外部主機可以 ping router</span>
</span></span><span class=line><span class=cl>iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 內部主機可以 ping 外部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p icmp --icmp-type echo-request -s 192.168.60.0/24 -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A FORWARD -p icmp --icmp-type echo-reply -d 192.168.60.0/24 -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 其他來往外部、內部的封包都應該被阻擋</span>
</span></span><span class=line><span class=cl>iptables -P FORWARD DROP
</span></span></code></pre></div><p>實驗外部主機採用 10.9.0.5，內部主機採用 192.168.60.5，總共個實驗</p><table><thead><tr><th style=text-align:left>實驗</th><th style=text-align:left>預期結果</th></tr></thead><tbody><tr><td style=text-align:left>[1] 外部 ping 內部</td><td style=text-align:left>失敗</td></tr><tr><td style=text-align:left>[2] 外部 ping router</td><td style=text-align:left>成功</td></tr><tr><td style=text-align:left>[3] 內部 ping 外部</td><td style=text-align:left>成功</td></tr><tr><td style=text-align:left>[4] 外部 telnet 內部</td><td style=text-align:left>失敗</td></tr><tr><td style=text-align:left>[4] 內部 telnet 外部</td><td style=text-align:left>失敗</td></tr></tbody></table><p>實驗結果如下圖所示</p><img src=Task2B-1.png alt=Task2B-1 width=100%><h3 class="relative group">Task 2C. Protecting Internal Servers<div id=task-2c-protecting-internal-servers class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-2c-protecting-internal-servers aria-label=Anchor>#</a></span></h3><p>Task 2C 要保護內網的 TCP 服務，要做到的事情如下</p><ol><li>外部主機只能 telnet 到 192.168.60.5，其他內部主機不行</li><li>外部主機無法存取其他內部主機</li><li>內部主機可以存取到其他內部主機</li><li>內部主機無法存取到外部主機</li><li>禁止使用 connection tracking 機制</li></ol><p>指令如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 外部主機只能 telnet 到 192.168.60.5</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp --dport <span class=m>23</span> -d 192.168.60.5 -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp --sport <span class=m>23</span> -s 192.168.60.5 -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 外部主機無法存取其他內部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp -d 192.168.60.0/24 -j DROP
</span></span><span class=line><span class=cl><span class=c1># 內部主機可以存取到其他內部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp -s 192.168.60.0/24 -d 192.168.60.0/24 -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 內部主機無法存取到外部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp -s 192.168.60.0/24 -j DROP
</span></span></code></pre></div><p>實驗外部主機採用 10.9.0.5，內部主機採用 192.168.60.5、192.168.60.6，總共四個實驗</p><table><thead><tr><th style=text-align:left>實驗</th><th style=text-align:left>預期結果</th></tr></thead><tbody><tr><td style=text-align:left>[1] 外部 telnet 192.168.60.5</td><td style=text-align:left>成功</td></tr><tr><td style=text-align:left>[2] 外部 telnet 192.168.60.6</td><td style=text-align:left>失敗</td></tr><tr><td style=text-align:left>[3] 192.168.60.5 telnet 192.168.60.6</td><td style=text-align:left>成功</td></tr><tr><td style=text-align:left>[4] 內部 telnet 外部</td><td style=text-align:left>失敗</td></tr></tbody></table><p>實驗結果如下圖所示</p><img src=Task2C-1.png alt=Task2C-1 width=100%><div class="flex px-4 py-3 rounded-md" style=background-color:#e63946><span class="ltr:pr-3 rtl:pl-3 flex items-center" style=color:#1d3557><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M159.3 5.4c7.8-7.3 19.9-7.2 27.7.1 27.6 25.9 53.5 53.8 77.7 84 11-14.4 23.5-30.1 37-42.9 7.9-7.4 20.1-7.4 28 .1 34.6 33 63.9 76.6 84.5 118 20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512 98.4 512 0 404.1.0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3.0 47.7-7 68.8-21 42.1-29.4 53.4-88.2 28.1-134.4-2.8-5.6-5.6-11.2-9.8-16.8l-50.6 58.8S180.8 199 175.1 192c-42 51.8-63.1 81.2-63.1 114.8C112 375.4 162.6 416 225.7 416z"/></svg>
</span></span><span style=color:#f1faee><p>Task 實作完要輸入以下指令清除新增的規則</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 清除所有在 filter table 上的規則</span>
</span></span><span class=line><span class=cl>iptables -F
</span></span><span class=line><span class=cl><span class=c1># 設定 FORWARD chain 上的 policy：預設放行</span>
</span></span><span class=line><span class=cl>iptables -P FORWARD ACCEPT
</span></span></code></pre></div><p>或直接透過重啟 docker (<code>docker restart &lt;docker ID></code>) 清除規則</p></span></div><h2 class="relative group">Task 3. Connections Tracking and Stateful Firewall<div id=task-3-connections-tracking-and-stateful-firewall class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-3-connections-tracking-and-stateful-firewall aria-label=Anchor>#</a></span></h2><p>Task 3 和 task 2 不同的是要建立 stateful 防火牆</p><h3 class="relative group">Task 3A. Experimenting with the Connection Tracking<div id=task-3a-experimenting-with-the-connection-tracking class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-3a-experimenting-with-the-connection-tracking aria-label=Anchor>#</a></span></h3><p>要做到 stateful firewall，會需要追蹤 connections 資訊，這可以透過 kernel 裡面的 <strong>conntrack</strong> 機制做到</p><ol><li>ICMP
第一個實驗是 ping 封包，首先分別進到 router 與 10.9.0.5 兩台機器，從 10.9.0.5 ping 到 12.168.60.5，再透過 router 觀察連線狀況，實驗如下
<img src=Task3A-1.png alt=Task3A-1 width=100%><ul><li>實驗開始前，先在 router 觀察當前連線狀況，發現沒有連線</li><li>開始 ping 之後，從 <code>conntrack -L</code> 指令結果可以看到有一條連線</li><li>ping 結束後仍繼續透過 <code>conntrack -L</code> 觀察連線狀況，約莫 30 秒連線關閉</li></ul></li><li>UDP
第二個實驗是 UDP 封包，分別進到 router（左）、10.9.0.5 （右上）與 192.168.60.5（右下）三台機器，實驗如下
<img src=Task3A-2.png alt=Task3A-2 width=100%><ul><li>實驗開始前，先在 router 觀察當前連線狀況，發現沒有連線</li><li>啟動 UDP server 後，也透過 router 觀察當前連線狀況，發現沒有連線</li><li>啟動 UDP client 後，也透過 router 觀察當前連線狀況，發現沒有連線</li><li>從 client 端傳送訊息到 seerver 端，連線開始出現</li><li>停止傳送訊息後約莫 30 秒，連線消失</li></ul></li><li>TCP
第三個實驗是 TCP 封包，分別進到 router（左）、10.9.0.5 （右上）與 192.168.60.5（右下）三台機器，實驗如下
<img src=Task3A-3.png alt=Task3A-3 width=100%><ul><li>實驗開始前，先在 router 觀察當前連線狀況，發現沒有連線</li><li>啟動 TCP server 後，也透過 router 觀察當前連線狀況，發現沒有連線</li><li>啟動 TCP client 後，也透過 router 觀察當前連線狀況，此時已建立一條連線</li><li>從 client 端傳送訊息到 seerver 端，連線一直出現</li><li>停止傳送訊息，連線仍在</li><li>當雙方都離開，連線才會終止</li></ul></li></ol><h3 class="relative group">Task 3B. Setting Up a Stateful Firewall<div id=task-3b-setting-up-a-stateful-firewall class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-3b-setting-up-a-stateful-firewall aria-label=Anchor>#</a></span></h3><p>這個 task 要根據連線完成 task 2C 所做的任務，除了內部主機現在是可以存取到外部主機的，詳細要求如下</p><ol><li>外部主機只能 telnet 到 192.168.60.5，其他內部主機不行</li><li>外部主機無法存取其他內部主機</li><li>內部主機可以存取外部主機</li><li>內部主機可以存取其他內部主機</li></ol><p>指令如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 外部主機只能 telnet 到 192.168.60.5</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -i eth0 -p tcp -d 192.168.60.5 --dport <span class=m>23</span> --syn -m conntrack --ctstate NEW -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 內部主機可以存取外部主機、其他內部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -i eth1 -p tcp --syn -m conntrack --ctstate NEW -j ACCEPT
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
</span></span><span class=line><span class=cl><span class=c1># 預設 DROP，同時也設定了外部主機無法存取其他內部主機</span>
</span></span><span class=line><span class=cl>iptables -A FORWARD -p tcp -j DROP
</span></span></code></pre></div><p>實驗外部主機採用 10.9.0.5，內部主機採用 192.168.60.5，總共四個實驗</p><table><thead><tr><th style=text-align:left>實驗</th><th style=text-align:left>預期結果</th></tr></thead><tbody><tr><td style=text-align:left>[1] 外部 telnet 192.168.60.5</td><td style=text-align:left>成功</td></tr><tr><td style=text-align:left>[2] 外部 telnet 192.168.60.6</td><td style=text-align:left>失敗</td></tr><tr><td style=text-align:left>[3] 內部 telnet 外部</td><td style=text-align:left>成功</td></tr><tr><td style=text-align:left>[4] 192.168.60.5 telnet 192.168.60.6</td><td style=text-align:left>成功</td></tr></tbody></table><p>實驗結果如下圖所示</p><img src=Task3B-1.png alt=Task3B-1 width=100%><h2 class="relative group">Task 4. Limiting Network Traffic<div id=task-4-limiting-network-traffic class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-4-limiting-network-traffic aria-label=Anchor>#</a></span></h2><p>Task 4 提到 <code>iptables</code> 限制流量的方式可ˇ透過 <code>limit</code> 模組做到，這題提供了兩個指令</p><ol><li><code>iptables -A FORWARD -s 10.9.0.5 -m limit --limit 10/minute --limit-burst 5 -j ACCEPT</code></li><li><code>iptables -A FORWARD -s 10.9.0.5 -j DROP</code></li></ol><p>第一個實驗只帶第一條指令，第二個實驗則是再加上第二條指令，觀察其行為差異，執行結果如下</p><img src=Task4-1.png alt=Task4-1 width=100%><p>在下完第一條指令後，router 平均每分鐘會接受 10 個來自 10.9.0.5 的封包，其中允許最一開始的五個封包不在此限制，也就是說最一開始的五個封包可能導致平均接受超過 10 個來自 10.9.0.5 封包，但沒關係，在這五個之後就會認真落實這條規則</p><p>會發現執行結果似乎還是讓封包很正常的通過了，並沒有出現預期限流的狀況，這是因為對於 not match（即非來自 10.9.0.5 或同樣來自 10.9.0.5 但已超出平均 10 個）的封包會由其他規則判定是否阻擋，而因為沒有其他規定說要阻擋下來，這些封包就會跟著通過 firewall</p><img src=Task4-2.png alt=Task4-2 width=100%><p>加上第二條指令後，告訴 firewall 同樣來自 10.9.0.5 的封包要擋下來，就會讓邏輯變成超過原本接受這平均 10 個來自 10.9.0.5 的封包之後，剩下的就會被阻擋下來，也成功達成限流的目的</p><h2 class="relative group">Task 5. Load Balancing<div id=task-5-load-balancing class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href=#task-5-load-balancing aria-label=Anchor>#</a></span></h2><p>Task 5 是負載平衡，會把封包轉發到不同 host 上以避免單一 host 接收太多封包負載過重影響可用性，這題會在 router 上設計並實驗兩種規則，一種是 nth mode；另一種是 random mode，實驗流程從 10.9.0.5 發送 UDP 封包至 10.9.0.11 (router)，router 會將封包轉發至 192.168.60.5/6/7，需要設計規則讓這兩種模式 192.068.60.5/6/7 接收到的封包是平均的</p><p>第一項實驗是在 nth mode 上進行，nth mode 就是 round robin，規則如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t nat -A PREROUTING -p udp --dport <span class=m>8080</span> -m statistic --mode nth --every <span class=m>3</span> --packet <span class=m>0</span> -j DNAT --to-destination 192.168.60.5:8080
</span></span><span class=line><span class=cl>iptables -t nat -A PREROUTING -p udp --dport <span class=m>8080</span> -m statistic --mode nth --every <span class=m>2</span> --packet <span class=m>0</span> -j DNAT --to-destination 192.168.60.6:8080
</span></span><span class=line><span class=cl>iptables -t nat -A PREROUTING -p udp --dport <span class=m>8080</span> -m statistic --mode nth --every <span class=m>1</span> --packet <span class=m>0</span> -j DNAT --to-destination 192.168.60.7:8080
</span></span></code></pre></div><p>上述指令告訴 router 每三個封包可以有一個進來 192.168.60.5，也就是說另外兩個會跑到其他 host 那邊，根據第二條規則又說每兩個封包可以進到 192.168.60.6，剩下的最後一個就會走到第三條規則，第三條規則說所有封包都可以來 192.168.60.7，這樣就完成題目要求每三個封包都會平均去各自不同的 host，執行結果如下圖</p><img src=Task5-1.png alt=Task5-1 width=100%><p>第二項實驗是在 random mode 下進行，規則如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>iptables -t nat -A PREROUTING -p udp --dport <span class=m>8080</span> -m statistic --mode random --probability 0.3 -j DNAT --to-destination 192.168.60.5:8080
</span></span><span class=line><span class=cl>iptables -t nat -A PREROUTING -p udp --dport <span class=m>8080</span> -m statistic --mode random --probability 0.4 -j DNAT --to-destination 192.168.60.6:8080
</span></span><span class=line><span class=cl>iptables -t nat -A PREROUTING -p udp --dport <span class=m>8080</span> -m statistic --mode random --probability 0.7 -j DNAT --to-destination 192.168.60.7:8080
</span></span></code></pre></div><p>上述指令告訴 router 有 30% 的機率可以進到 192.168.60.5，也就是說另外 70% 跑到其他 host 那邊，根據第二條規則又說有 40% 的機率可以進到 192.168.60.6，表示 192.168.60.6 接受封包的機率為 70% × 40% = 28%，也是接近 30%，最後說有 30% 的機率可以進到 192.168.60.7，表示封包進到 192.168.60.7 的機率為 70% × 60% × 30% = 29%，也差不多接近 30%，這樣就完成題目要求每三個封包會平均去各自不同的 host，執行結果如下圖</p><img src=Task5-2.png alt=Task5-2 width=100%></div></div><script type=text/javascript src=/js/page.min.407e5b2727c1f241c95d53db24c776bea71bfc18e09511b815d669ad8caca6e9e18a53864ad364b1ccccfa2f2956768d33cfe193bfb64d3406f3b5ece354ba57.js integrity="sha512-QH5bJyfB8kHJXVPbJMd2vqcb/BjglRG4FdZprYyspunhilOGStNksczM+i8pVnaNM8/hk7+2TTQG87Xs41S6Vw==" data-oid=views_posts/SEEDLAB-Firewall-Exploitation/_index.md data-oid-likes=likes_posts/SEEDLAB-Firewall-Exploitation/_index.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=April-Aries/April-Aries.github.io data-repo-id=R_kgDOPH5WZA data-category=Announcements data-category-id=DIC_kwDOPH5WZM4CsmaR data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=gruvbox_dark data-lang=zh-TW crossorigin=anonymous async></script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Luke</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-index-500" data-url=https://april-aries.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>